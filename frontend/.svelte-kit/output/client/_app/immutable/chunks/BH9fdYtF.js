const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./Ba_-_yuL.js","./CinR6i2W.js","./cb-04oXe.js"])))=>i.map(i=>d[i]);
import{_}from"./C1FmrZbK.js";import{d as w,w as v}from"./CinR6i2W.js";function y(){const{subscribe:l,set:W,update:s}=v({connected:!1,ws:null,messages:[],marketData:{},subscriptions:{}});let o=null,c=null,a=null;function d(){o&&o.readyState===WebSocket.OPEN||(o=new WebSocket("ws://localhost:8000/ws"),o.onopen=()=>{console.log("WebSocket connected"),s(e=>({...e,connected:!0,ws:o})),c&&(clearInterval(c),c=null),a&&clearInterval(a),a=setInterval(()=>{o.readyState===WebSocket.OPEN&&o.send(JSON.stringify({type:"ping",timestamp:Date.now()}))},3e4)},o.onmessage=e=>{const t=JSON.parse(e.data);console.log("[WebSocket] Received message:",t.type,t),t.type==="market_data"?(console.log("[WebSocket] Market data received:",t.data.length,"ticks"),s(n=>{const r={...n.marketData};return t.data.forEach(u=>{const m=u.instrument_token,S=u.last_price/100;console.log(`[WebSocket] Token ${m}: â‚¹${S.toFixed(2)}`),r[m]={...u,last_update:new Date().toISOString()}}),{...n,marketData:r,messages:[...n.messages,t]}}),_(()=>import("./Ba_-_yuL.js"),__vite__mapDeps([0,1,2]),import.meta.url).then(n=>{n.timeframeAnalysis}).catch(()=>{})):s(n=>({...n,messages:[...n.messages,t]}))},o.onclose=()=>{console.log("WebSocket disconnected"),s(e=>({...e,connected:!1,ws:null})),a&&(clearInterval(a),a=null),c||(c=setInterval(()=>{console.log("Attempting to reconnect..."),d()},5e3))},o.onerror=e=>{console.error("WebSocket error:",e)})}function b(){o&&(o.close(),o=null),c&&(clearInterval(c),c=null),a&&(clearInterval(a),a=null),s(e=>({...e,connected:!1,ws:null}))}function i(e){o&&o.readyState===WebSocket.OPEN?o.send(JSON.stringify(e)):console.warn("WebSocket not connected, cannot send message")}function f(e,t,n="quote"){if(!Array.isArray(t)||t.length===0){console.warn("No instruments to subscribe");return}i({type:"subscribe_market_data",source:e,instruments:t,mode:n}),s(r=>({...r,subscriptions:{...r.subscriptions,[e]:t}})),console.log(`Subscribed to ${t.length} instruments from ${e} in '${n}' mode`)}function k(e,t=null){i({type:"unsubscribe_market_data",source:e,instruments:t}),s(n=>{const r={...n.subscriptions};return delete r[e],{...n,subscriptions:r}}),console.log(`Unsubscribed from ${e}`)}function g(e){let t=null;return s(n=>{const r=n.marketData[e];return r&&(t=r.last_price/100),n}),t}function p(e){let t=null;return s(n=>(t=n.marketData[e],n)),t}return{subscribe:l,connect:d,disconnect:b,send:i,subscribeMarketData:f,unsubscribeMarketData:k,getLatestPrice:g,getMarketData:p}}const D=y(),h=w(D,l=>l.marketData);export{h as m,D as w};
